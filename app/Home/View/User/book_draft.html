<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
<meta name="renderer" content="webkit">
<title>我的作品列表</title>
<meta name="description" content="">
<meta name="keywords" content="">
<link rel="stylesheet" href="__PUBLIC__/Home/css/reset.css">
<link rel="stylesheet" href="__PUBLIC__/Home/css/style.css">
<link rel="stylesheet" href="__PUBLIC__/Home/css/back.css">
</head>
<body>
<!-- 引用 -->
<include file="Common/header" />


<div class="container mt20">
<div class="mainbox_wrapper">
    <div class="personal-center">
        <div class="ps-center rel">
                
               <!-- 引用 -->
               <include file="_book_top" /> 

        </div>
        <div class="back-stage txt-mid2 mgtb-20">
            <div class="aside2">

                  <!-- 引用 -->
                  <include file="_book_left" />
                  
            </div>
            <div class="fl">
                <div class="main2 fl">
                    <div class="header2"><span class="intro j-pageTitle">作家工作台</span></div>
                    <div class="mainRight pb0 fl">
                        <div class="msgBoxTitle">

                            <!-- 引用 -->
                            <include file="_book_top_nav" />
                            
                        </div>
                        <div class="managerWrap cf">
                            <div class="mLeftList fl">
                                <div class="leftListWrap">
                                    <div class="titleBox">
                                        <p>共 2 卷， 0 章</p>
                                    </div>
                                    <div class="sectionManage">
                                        <div class="sectionList">
                                            <ul>
                                                <if condition="$_GET['type']">
                                                    <li class="<if condition='$k eq 0'> act act_first </if>">
                                                        <div class="sectionBox" data-id="{$v.id}">
                                                            <p><em>无标题</em></p>
                                                            <p class="f12"><i>&nbsp;</i>&nbsp;</p>
                                                        </div>
                                                    </li>
                                                </if>
                                                <foreach name="list" item="v" key="k">
                                                    <li class="<if condition='($k eq 0) and (!$_GET["type"])'> act act_first </if>">
                                                        <div class="sectionBox" data-id="{$v.id}">
                                                            <p><em>{$v.title}</em></p>
                                                            <p class="f12"><i>{$v.time}</i>共{$v.num}字</p>
                                                        </div>
                                                    </li>
                                                </foreach>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mRightContent fl">
                                <div class="midWrap editWrap">
                                    <form name="formDraft" method="post" action="#2">
                                        <div class="sectionViewWrap">
                                            <div>
                                                <div class="sectionBtnBox cf">
                                                    <div class="titleBtn fr">
                                                        <if condition="!$_GET['type']">
                                                            <a class="button white cg-del" href="javascript:">删除</a>
                                                        </if>
                                                        
                                                        <a class="button white font_count" href="javascript:">字数统计</a>

                                                        <if condition="$_GET['type'] eq 'add'">
                                                            <a class="button white add_btn" data-href="{:U('Home/User/book_draft',array('id'=>$_GET['id']))}" href="javascript:">添加</a>
                                                        <else/>
                                                            <a class="button white save_btn" href="javascript:">保存</a>
                                                        </if>

                                                        <a class="button green publish_btn" href="javascript:"><span class="icon "></span>发布</a>
                                                    </div>
                                                    <em class="c999">发布至：</em>
                                                    <div class="select-wrap mid">
                                                        <select id="bjid" class="bjid">
                                                            <foreach name="juan_list" item="v">
                                                                <option value="{$v.id}">{$v.title}</option>
                                                            </foreach>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>


                                            <if condition="$_GET['type']">
                                                <div class="zwText">
                                                    <input type="text" class="title" placeholder="此处输入 章节号与章节名。示例：“第十章 天降奇缘”">
                                                    <textarea class="content" placeholder="请输入正文"></textarea>
                                                </div>
                                                <div class="say-area">
                                                    <p>
                                                        <textarea class="desc" value="" placeholder="作者的话（此段不计入字数）"></textarea>
                                                    </p>
                                                </div>
                                            <else/>
                                                <div class="zwText">
                                                    <input type="text" class="title" placeholder="此处输入 章节号与章节名。示例：“第十章 天降奇缘”">
                                                    <textarea class="content" placeholder="请输入正文"></textarea>
                                                </div>
                                                <div class="say-area">
                                                    <p>
                                                        <textarea class="desc" value="" placeholder="作者的话（此段不计入字数）"></textarea>
                                                    </p>
                                                </div>
                                            </if>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<div class="clear"></div>
<!-- 引用 -->
<include file="Common/footer" />


<!-- <div class="mask"></div> -->
<div class="maskUI maskUI2">
    <div class="popupWrap w380">
        <a class="icon closePopup" href="javascript:" title="关闭"></a>
        <h3>新建分卷</h3>
        <div class="popupBody p30">
            <div class="popupContent select">
                <p>分卷名称</p>
                <p class="mb20"><input class="longInput" type="text" value=""></p>
                <p>分卷介绍</p>
                <textarea></textarea>
            </div>
            <div class="confirmBtn">
                <a class="button full" href="javascript:">确定</a>
            </div>
        </div>
    </div>
</div>
<!-- <div class="maskUI maskUI5">
    <div class="popupWrap w380">
        <a attr="click:close;" class="icon closePopup" href="javascript:" title="关闭"></a>
        <h3>消息提示</h3>
        <div class="popupBody p30">
            <div class="popupContent centerTip">
                <p>删除成功，回收站内可找回</p>
            </div>
            <center class="confirmBtn">
                <a href="javascript:;" class="button">确定</a>
            </center>
        </div>
    </div>
</div> -->

<script src="__PUBLIC__/Home/js/jquery.min.js"></script>
<script src="__PUBLIC__/Home/js/index.js"></script>
<script src="__PUBLIC__/layer/layer.js"></script>
</body>
</html>


<script type="text/javascript">
    $(function(){
        $('#create_juan').click(function(){
            var bid=$('.book_juan .bid').val();
            var title=$('.book_juan .title').val();
            var content=$('.book_juan .content').val();

            if(title&&content){
                _ajax_add_juan(bid, title, content);
            }
        });

        //点击章节
        $('.sectionBox').click(function(){
            var zid=$(this).attr('data-id');
            $('.cg-del').attr('data-id', zid);
            $('.font_count').attr('data-id', zid);
            $('.save_btn').attr('data-id', zid);
            $('.publish_btn').attr('data-id', zid);

            _ajax_render_zhang_info(zid);
        });

        //删除
        $('.cg-del').click(function(){
            var zid=$(this).attr('data-id');

            layer.confirm('删除成功，回收站内可找回', {
                btn: ['确定','取消'] 
            }, function(){
                if(zid){
                    _ajax_cg_del_zhang(zid);
                }
            }, function(){
                //取消
            });
            
        });

        //统计字数
        $('.font_count').click(function(){
            var content=$('.mRightContent .editWrap .content').val();

            if(content){
                _ajax_font_count(content);
            }
        });

        //添加
        $('.add_btn').click(function(){
            var bjid=$('#bjid option:selected').val();

            var title=$('.mRightContent .editWrap .title').val();
            var content=$('.mRightContent .editWrap .content').val();
            var desc=$('.mRightContent .editWrap .desc').val();

            if(title&&content){
                var json=_ajax_add_zhang_not_publish(bjid, title, content, desc);
                if(json.code==0){
                    layer.msg("添加操作成功");
                    window.location.href=$('.add_btn').attr('data-href');
                }
            }
        });

        //保存
        $('.save_btn').click(function(){
            var zid=$(this).attr('data-id');
            var title=$('.mRightContent .editWrap .title').val();
            var content=$('.mRightContent .editWrap .content').val();
            var desc=$('.mRightContent .editWrap .desc').val();

            if(zid&&title&&content){
                var json=_ajax_save_zhang_draft(zid, title, content, desc);
                if(json.code==0){
                    layer.msg("操作成功");
                }
            }
        });

        //发布
        $('.publish_btn').click(function(){
            var bjid=$('#bjid option:selected').val();

            var zid=$(this).attr('data-id');
            var title=$('.mRightContent .editWrap .title').val();
            var content=$('.mRightContent .editWrap .content').val();
            var desc=$('.mRightContent .editWrap .desc').val();

            if(zid&&title&&content&&bjid){
                var json=_ajax_publish_zhang_draft(bjid, zid, title, content, desc);
                if(json.code==0){
                    layer.msg("发布成功");
                    setTimeout(function(){
                        window.location.reload();
                    },1000);
                }
            }
        });
        
        var getType="{$_GET['type']}";
        if(!getType){
            $('.act_first .sectionBox').trigger('click');
        }
    });
</script>
<script type="text/javascript">
    //异步渲染章节内容
    function _ajax_render_zhang_info(zid){
         var _json;
         $.ajax({  
             async:false,
             type:'get',  
             contentType:"application/x-www-form-urlencoded",
             url : "{:U('Home/User/ajax_render_zhang_info')}",
             data: {
                'zid':zid
             },
             dataType : 'json',
             success  : function(json) {
                 if(json.code==0){
                     var data=json.data;

                     $('.mRightContent .editWrap .title').val(data.title);
                     $('.mRightContent .editWrap .content').val(data.content);
                     $('.mRightContent .editWrap .desc').val(data.desc);
                 }else{
                     layer.msg(json.msg);
                 }
             },
             error  : function() {  
                 alert('error');
             }  
         }); 
         return _json;
    }

    //异步删除
    function _ajax_cg_del_zhang(zid){
        var _json;
        $.ajax({  
            type:'get',  
            url : "{:U('Home/User/ajax_cg_del_zhang')}",
            data:{ 
              zid:zid 
            },
            dataType : 'json',
            success  : function(json) {  
                if(json.code == 0){
                    _json=json;
                    layer.msg(json.msg);
                    window.location.reload();
                }else{
                    layer.msg(json.msg);
                    _json=json;
                }
            },
            error  : function() {  
                layer.msg('error');
            }  
        }); 
        return _json;
    }

    //异步恢复为草稿
    function _ajax_restore_zhang(zid){
        var _json;
        $.ajax({  
            type:'get',  
            url : "{:U('Home/User/ajax_restore_zhang')}",
            data:{ 
              zid:zid 
            },
            dataType : 'json',
            success  : function(json) {  
                if(json.code == 0){
                    _json=json;
                    layer.msg('章节已恢复至草稿箱');
                    window.location.reload();
                }else{
                    layer.msg(json.msg);
                    _json=json;
                }
            },
            error  : function() {  
                layer.msg('error');
            }  
        }); 
        return _json;
    }

    //异步统计字数
    function _ajax_font_count(content){
        $.ajax({  
            type:'post',  
            url : "{:U('Home/User/ajax_font_count')}",
            data:{ 
              content:content 
            },
            dataType : 'json',
            success  : function(json) {  
                if(json.code == 0){
                    layer.msg('总字数:'+json.data);
                }
            },
            error  : function() {  
                layer.msg('error');
            }  
        }); 
    }

    //保存
    function _ajax_save_zhang_draft(zid, title, content, desc){
        var _json;
        $.ajax({  
            async:false,
            type:'post',  
            contentType:"application/x-www-form-urlencoded", 
            url : "{:U('Home/User/ajax_edit_zhang')}",
            data:{ 
              id:zid,
              title:title,
              content:content,
              desc:desc,
              status:0 
            },
            dataType : 'json',
            success  : function(json) {
                _json=json;  
            },
            error  : function() {  
                layer.msg('error');
            }  
        }); 
        return _json;
    }

    //发布
    function _ajax_add_zhang_not_publish(bjid, title, content, desc){
        var _json;
        $.ajax({  
            async:false,
            type:'post',  
            contentType:"application/x-www-form-urlencoded", 
            url : "{:U('Home/User/ajax_add_zhang_not_publish')}",
            data:{ 
              bjid:bjid,
              title:title,
              content:content,
              desc:desc
            },
            dataType : 'json',
            success  : function(json) {
                _json=json;  
            },
            error  : function() {  
                layer.msg('error');
            }  
        }); 
        return _json;
    }

    //发布
    function _ajax_publish_zhang_draft(bjid, zid, title, content, desc){
        var _json;
        $.ajax({  
            async:false,
            type:'post',  
            contentType:"application/x-www-form-urlencoded", 
            url : "{:U('Home/User/ajax_edit_zhang')}",
            data:{ 
              bjid:bjid,
              id:zid,
              title:title,
              content:content,
              desc:desc,
              status:1 
            },
            dataType : 'json',
            success  : function(json) {
                _json=json;  
            },
            error  : function() {  
                layer.msg('error');
            }  
        }); 
        return _json;
    }
    
</script>